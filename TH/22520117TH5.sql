--11.	Ngày mua hàng (NGHD) của một khách hàng thành viên sẽ lớn hơn hoặc bằng ngày khách hàng đó đăng ký thành viên (NGDK).
--CREATE TRIGGER SS_HD1 ON HOADON
--FOR INSERT,UPDATE
--AS
--BEGIN 
----SO SANH
--	IF (EXISTS ( SELECT *
--		FROM INSERTED, KHACHHANG
--		WHERE INSERTED.MAKH = KHACHHANG.MAKH
--		AND INSERTED.NGHD < KHACHHANG.NGDK)) 
--	BEGIN
--		PRINT 'LOI: HOA DON KHONG HOP LE '
--		ROLLBACK TRANSACTION
--	END 
--END;
--CREATE TRIGGER UDP_NDK ON KHACHHANG
--FOR UPDATE
--AS
--BEGIN
--	IF( EXISTS ( SELECT * 
--				FROM HOADON, INSERTED
--				WHERE HOADON.MAKH = INSERTED.MAKH
--				AND HOADON.NGHD < INSERTED.NGDK))
--	BEGIN
--		PRINT ' ERROR: NGHD >= NGDK'
--		ROLLBACK TRANSACTION
--	END
--END;

--12.	Ngày bán hàng (NGHD) của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm.
--CREATE TRIGGER SS_HD02 ON HOADON
--FOR INSERT,UPDATE
--AS
--BEGIN 
----SO SANH
--	IF (EXISTS ( SELECT *
--		FROM INSERTED, NHANVIEN
--		WHERE INSERTED.MANV = NHANVIEN.MANV
--		AND INSERTED.NGHD < NHANVIEN.NGVL)) 
--	BEGIN
--		PRINT 'LOI: HOA DON KHONG HOP LE '
--		ROLLBACK TRANSACTION
--	END 
--END;
--CREATE TRIGGER UDP02_NDK ON NHANVIEN
--FOR UPDATE
--AS
--BEGIN
--	IF( EXISTS ( SELECT * 
--				FROM HOADON, INSERTED
--				WHERE HOADON.MANV = INSERTED.MANV
--				AND HOADON.NGHD < INSERTED.NGVL))
--	BEGIN
--		PRINT ' ERROR: NGHD >= NGVL'
--		ROLLBACK TRANSACTION
--	END
--END;
--13.	Trị giá của một hóa đơn là tổng thành tiền (số lượng*đơn giá) của các chi tiết thuộc hóa đơn đó.
--CREATE TRIGGER TRG_HD3 ON HOADON
--FOR INSERT 
--AS 
--BEGIN
--	UPDATE HOADON
--	SET TRIGIA = 0
--	WHERE HOADON.SOHD IN (SELECT SOHD FROM INSERTED)
--END;

--CREATE TRIGGER UPD_HD03 ON HOADON 
--FOR UPDATE 
--AS
--BEGIN
--	IF EXISTS (SELECT *
--	FROM INSERTED 
--	WHERE TRIGIA <> (SELECT SUM(SL *GIA) FROM CTHD JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
--	WHERE CTHD.SOHD = INSERTED.SOHD))
--	BEGIN
--	RAISERROR('LOI: HOA DON KHONG HOP LE!',16,1)
--	ROLLBACK TRANSACTION
--	END
--ELSE
--	BEGIN
--	PRINT('CAP NHAT DON THANH CONG')
--	END
--END
--CREATE TRIGGER TRG_CTHD1 ON CTHD
--FOR INSERT
--AS 
--BEGIN
--	UPDATE HOADON
--	SET TRIGIA = TRIGIA + (SELECT SUM(SL*GIA) FROM INSERTED JOIN SANPHAM SP ON INSERTED.MASP = SP.MASP)
--	FROM HOADON JOIN INSERTED ON HOADON.SOHD = INSERTED.SOHD
--	WHERE HOADON.SOHD = INSERTED.SOHD
--END

--CREATE TRIGGER DEL_CTHD1 ON CTHD
--FOR DELETE
--AS  
--BEGIN
--	UPDATE HOADON
--	SET TRIGIA = TRIGIA - (SELECT SUM(SL*GIA) FROM DELETED JOIN SANPHAM SP ON DELETED.MASP = SP.MASP)
--	FROM HOADON JOIN DELETED ON HOADON.SOHD = DELETED.SOHD
--	WHERE HOADON.SOHD = DELETED.SOHD
--END

--CREATE TRIGGER UPD_CTHD1 ON CTHD
--FOR UPDATE
--AS 
--BEGIN
--	UPDATE HOADON
--	SET TRIGIA = TRIGIA
--	+ (SELECT SUM( SL * GIA) 
--		FROM INSERTED I JOIN SANPHAM S ON I.MASP = S.MASP
--		WHERE I.SOHD = HOADON.SOHD)
--	- (SELECT SUM( SL * GIA)
--		FROM DELETED D JOIN SANPHAM S ON D.MASP = S.MASP
--		WHERE D.SOHD = HOADON.SOHD)
--	FROM (HOADON JOIN INSERTED ON HOADON.SOHD = INSERTED.SOHD)
--		JOIN DELETED ON HOADON.SOHD = DELETED.SOHD
--	PRINT 'TRI GIA DA DUOC CAP NHAT!'
--END
--14.	Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua
--CREATE TRIGGER TRGI_HD1 ON HOADON
--FOR INSERT
--AS 
--BEGIN
--	UPDATE KHACHHANG
--	SET DOANHSO = DOANHSO + (SELECT SUM(TRIGIA) FROM INSERTED JOIN KHACHHANG  ON INSERTED.MAKH = KHACHHANG.MAKH)
--	WHERE KHACHHANG.MAKH IN (SELECT MAKH FROM INSERTED)
--END

--CREATE TRIGGER DELI_HD1 ON HOADON
--FOR DELETE
--AS  
--BEGIN
--	UPDATE KHACHHANG
--	SET DOANHSO = DOANHSO - (SELECT SUM(TRIGIA) FROM DELETED JOIN KHACHHANG  ON DELETED.MAKH = KHACHHANG.MAKH)
--	WHERE KHACHHANG.MAKH IN ( SELECT MAKH FROM DELETED)
--END

--CREATE TRIGGER UPDI_HD1 ON HOADON
--FOR UPDATE
--AS 
--BEGIN
--	UPDATE KHACHHANG
--	SET DOANHSO = DOANHSO
--	+ (SELECT SUM( TRIGIA) FROM INSERTED  
--		WHERE INSERTED.MAKH = KHACHHANG.MAKH)
--	- (SELECT SUM( TRIGIA) FROM DELETED 
--		WHERE DELETED.MAKH = KHACHHANG.MAKH)
--	FROM (KHACHHANG JOIN INSERTED ON KHACHHANG.MAKH = INSERTED.MAKH)
--		JOIN DELETED ON KHACHHANG.MAKH = DELETED.MAKH
--	PRINT 'TRI GIA DA DUOC CAP NHAT!'
--END
-----------------------------
--9.	Lớp trưởng của một lớp phải là học viên của lớp đó.
--CREATE TRIGGER TRG_INS_GV1 ON LOP
--FOR UPDATE, INSERT
--AS 
--BEGIN
--	IF NOT EXISTS (SELECT * FROM INSERTED I, HOCVIEN HV
--	WHERE I.TRGLOP = HV.MAHV AND I.MALOP = HV.MALOP)
--	BEGIN
--		PRINT 'ERROR: LOP TRG CUA LOP PHAI LA HOC VIEN CUA LOP DO'
--		ROLLBACK TRANSACTION
--	END
--END

--CREATE TRIGGER TRG_DEL_GV1 ON HOCVIEN
--FOR UPDATE, DELETE
--AS
--BEGIN
--	IF EXISTS ( SELECT * FROM DELETED D, LOP L
--	WHERE D.MAHV = L.TRGLOP AND D.MALOP = L.MALOP)
--	BEGIN
--		PRINT 'ERROR: LOP TRG CUA LOP PHAI LA HOC VIEN CUA LOP DO'
--		ROLLBACK TRANSACTION
--	END
--END
--10.	Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.
--CREATE TRIGGER TRG_INS_UPD_GV2 ON KHOA
--FOR INSERT,UPDATE
--AS
--BEGIN
--	IF NOT EXISTS (SELECT * FROM INSERTED I, GIAOVIEN GV
--	WHERE I.TRGKHOA = GV.MAGV AND I.MAKHOA = GV.MAKHOA)
--		BEGIN
--			PRINT'ERROR: TRG KHOA CUA KHOA PHAI LA GV CUA KHOA DO'
--			ROLLBACK TRANSACTION
--		END
--	ELSE
--		IF EXISTS (SELECT HOCVI FROM INSERTED I, GIAOVIEN GV
--		WHERE I.TRGKHOA = GV.MAGV AND I.MAKHOA = GV.MAKHOA
--		AND HOCVI NOT IN ('TS','PTS'))
--		BEGIN
--			PRINT'ERROR: TRG KHOA PHAI CO HOC VI LA TS OR PTS'
--			ROLLBACK TRANSACTION
--		END
--END

--CREATE TRIGGER TRG_DEL_UPD_GV2 ON GIAOVIEN 
--FOR DELETE,UPDATE 
--AS 
--BEGIN 
--	IF EXISTS ( SELECT * FROM KHOA, DELETED 
--			WHERE KHOA.TRGKHOA = DELETED.MAGV
--			AND DELETED.MAKHOA = KHOA.MAKHOA)
--		BEGIN 
--			PRINT 'ERROR: GV HIEN TAI DANG LA TRG KHOA'
--			ROLLBACK TRANSACTION
--		END
--	ELSE
--		IF EXISTS ( SELECT HOCVI FROM KHOA, INSERTED 
--				WHERE INSERTED.MAGV = KHOA.TRGKHOA AND INSERTED.MAKHOA = KHOA.MAKHOA
--				AND HOCVI NOT IN ('TS', 'PTS'))
--	BEGIN
--		PRINT 'ERROR: HOCVI PHAI LA TS OR PTS'
--		ROLLBACK TRANSACTION
--	END
--END;
--15.	Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.
--CREATE TRIGGER TRG_INS_UPD_HD15 ON KETQUATHI
--FOR INSERT,UPDATE
--AS
--BEGIN 
--	IF (EXISTS ( SELECT *
--		FROM INSERTED, GIANGDAY
--		WHERE INSERTED.MAMH = GIANGDAY.MAMH
--		AND GIANGDAY.TUNGAY < INSERTED.NGTHI AND GIANGDAY.DENNGAY > INSERTED.NGTHI)) 
--	BEGIN
--		PRINT 'LOI: KHONG HOP LE '
--		ROLLBACK TRANSACTION
--	END 
--END;
--CREATE TRIGGER UDP_GV15 ON GIANGDAY
--FOR UPDATE
--AS
--BEGIN
--	IF( EXISTS ( SELECT * 
--				FROM KETQUATHI, INSERTED
--				WHERE KETQUATHI.MAMH = INSERTED.MAMH
--				AND  INSERTED.TUNGAY < KETQUATHI.NGTHI AND INSERTED.DENNGAY > KETQUATHI.NGTHI))
--	BEGIN
--		PRINT ' ERROR: NGTHI > DENNGAY'
--		ROLLBACK TRANSACTION
--	END
--END;
--16.	Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.
--CREATE TRIGGER TRG_INS_UPD_GV16 ON GIANGDAY
--FOR INSERT,UPDATE
--AS
--	DECLARE @SL_MONHOC INT
--	SELECT @SL_MONHOC = COUNT(A.MAMH) FROM GIANGDAY A, INSERTED B
--	WHERE A.MALOP = B.MALOP AND A.HOCKY = B.HOCKY AND A.NAM = B.NAM
--	IF(@SL_MONHOC >3)
--		BEGIN
--		ROLLBACK TRANSACTION
--		PRINT 'ERROR: LOP DA HOC HON 3 MON TRONG CUNG 1HK,NAM'
--END
--17.	Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.
--CREATE TRIGGER TRG_INS_GV17 ON HOCVIEN
--FOR INSERT
--AS 
--BEGIN
--	UPDATE LOP
--	SET SISO = SISO + (SELECT COUNT(MAHV) FROM INSERTED JOIN LOP  ON INSERTED.MALOP = LOP.MALOP)
--	WHERE LOP.MALOP IN (SELECT MALOP FROM INSERTED)
--END

--CREATE TRIGGER TRG_DEL_GV17 ON HOCVIEN
--FOR DELETE
--AS  
--BEGIN
--	UPDATE LOP
--	SET SISO = SISO - (SELECT COUNT(MAHV) FROM DELETED JOIN LOP  ON DELETED.MALOP = LOP.MALOP)
--	WHERE LOP.MALOP IN ( SELECT MALOP FROM DELETED)
--END

--CREATE TRIGGER UPDI_HD1 ON HOCVIEN
--FOR UPDATE
--AS 
--BEGIN
--	UPDATE LOP
--	SET SISO = SISO
--	+ (SELECT COUNT(MAHV) FROM INSERTED  
--		WHERE INSERTED.MALOP = LOP.MALOP)
--	- (SELECT COUNT(MAHV) FROM DELETED 
--		WHERE DELETED.MALOP = LOP.MALOP)
--	FROM (LOP JOIN INSERTED ON LOP.MALOP = INSERTED.MALOP)
--		JOIN DELETED ON LOP.MALOP = DELETED.MALOP
--	PRINT 'SI SO DA DUOC CAP NHAT!'
--END
--18.	Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng một bộ không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và (“B”,”A”).
--CREATE TRIGGER TRG_INS_UPD_GV18 ON DIEUKIEN
--FOR INSERT, UPDATE
--AS 
--	DECLARE @MAMH VARCHAR(10),
--			@MAMH_TRUOC VARCHAR(10)
--	SELECT @MAMH = MAMH, @MAMH_TRUOC = MAMH_TRUOC FROM INSERTED
--	IF ((@MAMH = @MAMH_TRUOC)
--		OR (@MAMH IN (SELECT MAMH_TRUOC FROM DIEUKIEN
--						WHERE MAMH = @MAMH_TRUOC))
--		OR (@MAMH_TRUOC IN ( SELECT MAMH FROM DIEUKIEN
--						WHERE MAMH_TRUOC = @MAMH)))
--	BEGIN
--		ROLLBACK TRANSACTION
--		PRINT 'DK KO HOP LE'
--END
--19.	Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau
--CREATE TRIGGER TRG_INS_UPD_GV19 ON GIAOVIEN
--FOR INSERT, UPDATE
--AS 
--	DECLARE @MUCLUONG MONEY,
--			@MAGV CHAR(4)
--	SELECT DISTINCT @MUCLUONG = A.MUCLUONG, @MAGV = I.MAGV FROM GIAOVIEN A, INSERTED I
--	WHERE A.HOCHAM = I.HOCHAM AND A.HOCVI = I.HOCVI AND A.HESO = I.HESO
--	AND A.MAGV <>I.MAGV

--	UPDATE GIAOVIEN
--	SET MUCLUONG = @MUCLUONG
--	WHERE MAGV = @MAGV
--20.	Học viên chỉ được thi lại (lần thi >1) khi điểm của lần thi trước đó dưới 5.
--CREATE TRIGGER TRG_INS_UPD_GV20 ON KETQUATHI
--FOR INSERT, UPDATE
--AS 
--	DECLARE @LANTHI INT,
--			@DIEM NUMERIC(4,2)
--	SELECT @LANTHI = LANTHI FROM INSERTED

--	IF (@LANTHI >1)
--	BEGIN
--		SELECT @DIEM = B.DIEM FROM INSERTED A, KETQUATHI B
--		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND B.LANTHI = @LANTHI -1
--		IF (@DIEM >=5)
--		BEGIN
--			ROLLBACK TRANSACTION
--			PRINT 'HV NAY DA THI DAY'
--		END
--	END
--21.	Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn học)
--CREATE TRIGGER TRG_INS_UPD_GV21 ON KETQUATHI
--AFTER INSERT, UPDATE
--AS
--BEGIN
--	IF(
--		SELECT COUNT(*)
--		FROM KETQUATHI KQT1 JOIN INSERTED KQT2
--			ON KQT1.MAHV = KQT2.MAHV
--				AND KQT1.MAMH = KQT2.MAMH
--				AND KQT1.LANTHI = KQT2.LANTHI
--				AND KQT1.NGTHI = KQT1.NGTHI
--				)>0
--		BEGIN
--			PRINT 'ERROR: NGAU THI SAU LON HON NGAY THI TRC'
--		END
--		ELSE
--		BEGIN
--			PRINT'THANH CONG'

--		END;
--	END;
--22.	Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau khi học xong những môn học phải học trước mới được học những môn liền sau).
--CREATE TRIGGER TRG_INS_UDP_GV22 ON GIANGDAY
--AFTER INSERT , UPDATE
--AS 
--BEGIN
--IF (SELECT COUNT(*)
--	FROM INSERTED GD1
--		JOIN DIEUKIEN DK
--			ON GD1.MAMH = DK.MAMH
--		JOIN GIANGDAY GD2
--			ON GD2.MAMH = DK.MAMH_TRUOC
--				AND GD1.MALOP = GD2.MALOP
--				AND GD1.TUNGAY = GD2.DENNGAY
--				) > 0
--	BEGIN 
--		PRINT 'ERROR CAN HOAN THANH BAT BUOC MH_TRUOC'
--	END
--	ELSE 
--	BEGIN
--		PRINT'THANH CONG'
--	END;
--END;
--23.	Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách
--CREATE TRIGGER TRG_INS_UPD_GV24 ON GIANGDAY
--FOR INSERT , UPDATE
--AS
--DECLARE @MAKHOA1 CHAR(4),
--		@MAKHOA2 CHAR(4)

--SELECT @MAKHOA1 = MH.MAKHOA, @MAKHOA2 = GV.MAKHOA
--FROM INSERTED I, MONHOC MH, GIAOVIEN GV
--WHERE I.MAMH =  MH.MAMH AND GV.MAGV = I.MAGV

--IF(@MAKHOA1 <> @MAKHOA2)
--	BEGIN
--		ROLLBACK TRANSACTION
--		PRINT 'ERROR PHAI THUOC KHOA GV PHU TRACH'
--	END
--ELSE
--PRINT 'THANH CONG'
